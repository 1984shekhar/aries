
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML>
  <HEAD>
<!--
    Pier's plugin always overwrites the stylesheet so lets explicitly use another one
    <link type="text/css" rel="stylesheet" href="autoexport:///SM/resources/space.css">
-->
    <LINK type="text/css" rel="stylesheet" href="resources/site.css">
    <SCRIPT src="resources/space.js" type="text/javascript"></SCRIPT>
    <TITLE>
Writing lighweight components
    </TITLE>
  <META http-equiv="Content-Type" content="text/html;charset=UTF-8"></HEAD>
  <BODY onload="init()">

    <!-- Banner -->
    <DIV id="site-banner">

      <TABLE border="0" cellpadding="0" cellspacing="0" width="100%">
        <TR>
          <TD align="left" class="topbardiv" nowrap="">
            <IMG border="0" src="http://incubator.apache.org/servicemix/images/logo.jpg">
          </TD>
          <TD align="right" nowrap="">
            <IMG border="0" src="http://incubator.apache.org/images/apache-incubator-logo.png">
          </TD>
        </TR> 
      </TABLE>

    </DIV>

    <!-- Bread crumbs and Quick Links -->
    <DIV id="site-navbar">
      <TABLE border="0" cellpadding="0" cellspacing="0" width="100%">
        <TR>
          <TD align="left" valign="middle" nowrap="">
            <DIV id="site-breadcrumbs">
<A href="home.html" title="ServiceMix">ServiceMix</A>&nbsp;&gt;&nbsp;<A href="home.html" title="Home">Home</A>&nbsp;&gt;&nbsp;<A href="overview.html" title="Overview">Overview</A>&nbsp;&gt;&nbsp;<A href="faq.html" title="FAQ">FAQ</A>&nbsp;&gt;&nbsp;<A href="using-servicemix.html" title="Using ServiceMix">Using ServiceMix</A>&nbsp;&gt;&nbsp;<A href="why-does-servicemix-seems-to-hang-after-some-processing.html" title="Why does ServiceMix seems to hang after some processing">Why does ServiceMix seems to hang after some processing</A>&nbsp;&gt;&nbsp;<A href="" title="Writing lighweight components">Writing lighweight components</A>
            </DIV>
          </TD>
          <TD align="right" valign="middle" nowrap="">
            <DIV id="site-quicklinks">
<P><A href="download.html" title="Download">Download</A> &#124; <A href="documentation.html" title="Documentation">Documentation</A> &#124; <A href="javadocs.html" title="JavaDocs">JavaDocs</A> &#124; <A href="source.html" title="Source">Source</A> &#124; <SPAN class="nobr"><A href="home.html" title="Visit page outside Confluence" rel="nofollow">Wiki<SUP><IMG class="rendericon" src="http://goopen.org/confluence/images/icons/linkext7.gif" height="0" width="0" align="absmiddle" alt="" border="0"></SUP></A></SPAN> &#124; <A href="discussion-forums.html" title="Discussion Forums">Discussion Forums</A> &#124; <A href="support.html" title="Support">Support</A></P>
            </DIV>
          </TD>
        </TR> 
      </TABLE>
    </DIV>

<!-- Integrate google search later.
          <form name="search" action="http://www.google.com/search" method="get">
            <input type="hidden" name="ie" value="UTF- 8" />
            <input type="hidden" name="oe" value="UTF- 8" />
            <input type="hidden" name="domains" value="" />
            <input type="hidden" name="sitesearch" value="" />
            <input type="text" name="q" maxlength="255" value="" />        
            <input type="submit" name="btnG" value="Google Search" />
          </form>
-->

      <DIV id="site-content">
        <TABLE>
        <TR>
        <TD valign="top">
          <DIV id="site-navigation">
<H3><A name="Navigation-Overview"></A>Overview</H3>

<UL class="alternate" type="square">
	<LI><A href="home.html" title="Home">Home</A></LI>
	<LI><SPAN class="nobr"><A href="http://www.apache.org/" title="Visit page outside Confluence" rel="nofollow">ASF<SUP><IMG class="rendericon" src="http://goopen.org/confluence/images/icons/linkext7.gif" height="0" width="0" align="absmiddle" alt="" border="0"></SUP></A></SPAN></LI>
	<LI><A href="license.html" title="License">License</A></LI>
	<LI><A href="faq.html" title="FAQ">FAQ</A></LI>
	<LI><A href="download.html" title="Download">Download</A></LI>
	<LI><A href="sitemap.html" title="SiteMap">SiteMap</A></LI>
</UL>


<H3><A name="Navigation-Community"></A>Community</H3>

<UL class="alternate" type="square">
	<LI><A href="support.html" title="Support">Support</A></LI>
	<LI><A href="discussion-forums.html" title="Discussion Forums">Discussion Forums</A></LI>
	<LI><A href="mailing-lists.html" title="Mailing Lists">Mailing Lists</A></LI>
	<LI><SPAN class="nobr"><A href="navigation.html" title="Visit page outside Confluence" rel="nofollow">Wiki<SUP><IMG class="rendericon" src="http://goopen.org/confluence/images/icons/linkext7.gif" height="0" width="0" align="absmiddle" alt="" border="0"></SUP></A></SPAN></LI>
	<LI><SPAN class="nobr"><A href="http://issues.apache.org/activemq/browse/SM" title="Visit page outside Confluence" rel="nofollow">Issues<SUP><IMG class="rendericon" src="http://goopen.org/confluence/images/icons/linkext7.gif" height="0" width="0" align="absmiddle" alt="" border="0"></SUP></A></SPAN></LI>
	<LI><A href="contributing.html" title="Contributing">Contributing</A></LI>
	<LI><A href="team.html" title="Team">Team</A></LI>
	<LI><A href="users.html" title="Users">Users</A></LI>
</UL>


<H3><A name="Navigation-Documentation"></A>Documentation</H3>

<UL class="alternate" type="square">
	<LI><A href="getting-started.html" title="Getting Started">Getting Started</A></LI>
	<LI><A href="features.html" title="Features">Features</A></LI>
	<LI><A href="running.html" title="Running">Running</A></LI>
	<LI><A href="examples.html" title="Examples">Examples</A></LI>
	<LI><A href="servicemix-eip.html" title="servicemix-eip">Enterprise Integration Patterns</A></LI>
	<LI><A href="use-cases-whole.html" title="Use Cases (whole)">Use Cases &#40;whole&#41;</A></LI>
	<LI><A href="configuration.html" title="Configuration">Configuration</A></LI>
	<LI><A href="xml-reference.html" title="Xml Reference">Xml Reference</A></LI>
	<LI><A href="management.html" title="Management">Management</A></LI>
	<LI><A href="architecture.html" title="Architecture">Architecture</A></LI>
	<LI><A href="clustering.html" title="Clustering">Clustering</A></LI>
	<LI><A href="nmr-flows.html" title="NMR Flows">NMR Flows</A></LI>
	<LI><A href="articles.html" title="Articles">Articles</A></LI>
	<LI><A href="features.html" title="Features">Features</A></LI>
	<LI><A href="integration.html" title="Integration">Integration</A></LI>
	<LI><A href="components.html" title="Components">Components</A></LI>
	<LI><A href="tooling-and-utilities.html" title="Tooling and Utilities">Tooling</A></LI>
</UL>


<H3><A name="Navigation-Developers"></A>Developers</H3>

<UL class="alternate" type="square">
	<LI><A href="source.html" title="Source">Source</A></LI>
	<LI><A href="building.html" title="Building">Building</A></LI>
	<LI><A href="ideas.html" title="Ideas">Ideas</A></LI>
	<LI><A href="becoming-a-committer.html" title="Becoming a committer">Becoming a committer</A></LI>
	<LI><A href="release-guide.html" title="Release Guide">Release Guide</A></LI>
	<LI><A href="related-projects.html" title="Related Projects">Related Projects</A></LI>
	<LI><A href="tools.html" title="Tools">Tools</A></LI>
</UL>

          </DIV>
        </TD>
        <TD valign="top">
          <DIV id="site-page">

<!--          
            <div class="pagetitle">Writing lighweight components</div>
-->
            <DIV class="wiki-content"><P>Related docs:</P>
<UL>
	<LI><A href="what-is-a-lightweight-component.html" title="What is a lightweight component">What is a lightweight component</A></LI>
	<LI><A href="component-helper-classes.html" title="Component helper classes">Component helper classes</A></LI>
	<LI><A href="why-does-my-sender-not-send.html" title="Why does my sender not send">Why does my sender not send</A></LI>
	<LI><A href="pojo-support.html" title="POJO support">POJO support</A></LI>
</UL>


<P>Note that the following points also apply to standard components, but the examples / code is for lightweight components.</P>

<H2><A name="Writinglighweightcomponents-CorrectlyhandlingJBIexchangepatterns"></A>Correctly handling JBI exchange patterns</H2>

<P>When your component receives an exchange with an ACTIVE status, you have to send the exchange back (either ACTIVE with a response / fault, or DONE / ERROR status).</P>

<P>If you component is only a consumer but uses asynchronous send, you will receive DONE / ERROR status.  Be sure to receive them (by implementing the MessageExchangeListener interface) or polling them from the DeliveryChannel so that your component queue is not filled (this would block the provider component).</P>

<H2><A name="Writinglighweightcomponents-Handlingstreams"></A>Handling streams</H2>

<P>Take care of streams inside the content of the NormalizedMessage or attachments.<BR>
A stream may not be read twice, so if you need to do that, make sure to copy the stream to a re-readable source before processing.<BR>
In addition, you have to process the stream before sending back the DONE / ERROR status, because the consumer may close the stream when the status is received.</P>

<H2><A name="Writinglighweightcomponents-Synchronous%2Fasynchronous"></A>Synchronous / asynchronous</H2>

<P>Sending JBI exchanges synchronously is much more easier to program.<BR>
However there are some drawbacks:</P>
<UL>
	<LI>the current thread may be waiting for the answer doing nothing</LI>
	<LI>synchronous send can not be used with the JCA flow</LI>
</UL>


<H2><A name="Writinglighweightcomponents-Clustering"></A>Clustering</H2>

<P>If you want your component to be clustered (the same endpoint is activated on several ServiceMix containers with a clusterd flow), you need to take care of any state maintained by your component.  ServiceMix assumes that your component is statefull and/or uses synchronous send, and thus, if your component send an exchange, the response or status will be returned back to the exact same component (on the same container instance).  The main drawback is the node fails, the JBI exchange is lost until the node is restarted.</P>

<P>If your component does not maintain any state, of if the state is distributed across the whole cluster (for example you use a single database for all nodes), you can set the JbiConstants.STATELESS_PROVIDER or JbiConstants.STATELESS_CONSUMER property to Boolean.TRUE on the exchange.  The clustered flows will ensure that the responses / status will be load-balanced across all nodes. Note that it only works if you use asynchronous send.</P>

<H2><A name="Writinglighweightcomponents-Transactional"></A>Transactional</H2>

<P>TODO</P>

<H2><A name="Writinglighweightcomponents-Componenttypes"></A>Component types</H2>


<H3><A name="Writinglighweightcomponents-Consumercomponent"></A>Consumer component</H3>

<P>You should inherit the ComponentSupport class and implements the MessageExchangeListener (if you use async send).</P>


<H3><A name="Writinglighweightcomponents-Providercomponent"></A>Provider component</H3>

<P>You can extend the TransformerComponentSupport class.</P>

<H3><A name="Writinglighweightcomponents-Consumer%2Fprovidercomponent"></A>Consumer / provider component</H3>

<P>TODO:</P></DIV>
          
                  </DIV>
        </TD>
      </TR>
      </TABLE>     
      </DIV>
    </DIV>
    <DIV id="site-footer">
          Added by     <A href="http://goopen.org/confluence/users/viewuserprofile.action?username=jstrachan">James Strachan</A>,
    last edited by     <A href="http://goopen.org/confluence/users/viewuserprofile.action?username=jstrachan">James Strachan</A> on May 05, 2006
                  
      (<A href="http://goopen.org/confluence/pages/editpage.action?pageId=4921">edit page</A>)
    </DIV>

  </BODY>

</HTML>